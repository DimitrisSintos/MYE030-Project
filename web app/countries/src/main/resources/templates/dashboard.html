<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" th:href="@{/css/main.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" th:href="@{/css/multi-select.css}" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" ></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js" charset="utf-8"></script>
    <!-- Multi Select -->
    <script type="text/javascript" th:src="@{/js/jquery.multi-select.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery.quicksearch.js}"></script>
    <!-- Single select with search -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <title>Countries Charts Dashboard</title>
</head>

<body>
    {% comment %} <div class="page-head-title">MYE030-Project, Powered by Toumpaniasmenoi &#128170</div> {% endcomment %}
    <div class="page-head-title">MYE030-Project</div>
    
    <main class="text-center" id ="main">

        <div class="charts-container">
        </div>
    </main>
    <i class="fa-solid fa-circle-plus add-btn-icon" onclick="addChart()"></i>
    <div class="sidebar-tab" id="sidebar-tab">
        <div class="vertical-text text-center" id="sidebar-tab-text" onclick="toggleSidebar()"><span class="arrow vertical-text"></span></div>
    </div>
    <!--The acutal content of the sidebar-->
    <div class="sidebar" id="sidebar">
        <div class="tabs">
            <div class="tab">
                <input type="radio" name="css-tabs" id="tab-1" checked class="tab-switch">
                <label for="tab-1" class="tab-label">Data Source</label>
                <div class="tab-content">
                    <div id="dataSource" class="data-source">
                        <div class="my-row">
                            
                            <div class="option">
                                <label for="chartType">Chart Type</label>
                                <select class="form-control" name="chartType" id="chartType">
                                    <option value="lines+markers">Timelines</option>
                                    <option value="bar">Bar Charts</option>
                                    <option value="markers">Scatter Plot</option>
                                </select>
                            </div>
                        </div>
                        <div id="time-series-selector">
                            <div class="d-flex flex-row align-items-center mb-2">
                                <h6>Select Countries</h6>
                            </div>
                            <select  multiple="multiple" id="countriesSelect" name="countriesSelect[]">
                                <option th:each="country : ${countries}" th:value="${country.iso_code}" th:text="${country.display_name}"></option>
                            </select>
                            <div class="d-flex flex-row align-items-center mb-2">
                                <h6>Select Fields</h6>
                            </div>
                            <select multiple="multiple" id="fieldsSelect" name="fieldsSelect[]">
                                <option th:each="fieldOption : ${fieldOptions}" th:value="${fieldOption.value}" th:text="${fieldOption.name}"></option>

                            </select>
                            <h6>Year Range Selector</h6>
                            <div class="my-row">
                                <input class="year-input" type="number" name="min-year" id="min-year">
                                <span>-</span>
                                <input class="year-input" type="number" name="max-year" id="max-year">
                            </div>
                            <div class="my-row" hidden>
                                <p class="mb-0 mr-1">Aggregate Time</p>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="none" name="customRadioInline1" class="custom-control-input">
                                    <label class="custom-control-label" for="none">None</label>
                                </div>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="5" name="customRadioInline1" class="custom-control-input">
                                    <label class="custom-control-label" for="5">5 years</label>
                                </div>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="10" name="customRadioInline1" class="custom-control-input">
                                    <label class="custom-control-label" for="10">10 years</label>
                                </div>
                            </div>
                        </div>
                        <div id="scatter-selector">
                            <div class="my-row">
                                <p class="mb-0 mr-1">Fixed:</p>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="country" name="scatterRadio" class="custom-control-input" checked>
                                    <label class="custom-control-label" for="country">Country</label>
                                </div>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="year" name="scatterRadio" class="custom-control-input">
                                    <label class="custom-control-label" for="year">Year</label>
                                </div>
                            </div>
                            <div class="my-row mt-4" id="fixedCountry-countries">
                                <div class="form-group">
                                    <select class="form-control single-selection" id="single-country">  
                                        <option value="">Select a country</option>
                                        <option th:each="country : ${countries}" th:value="${country.iso_code}" th:text="${country.display_name}"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4" id="fixedYear-countries">
                                <h5>Select Countries:</h5>
                                <select  multiple="multiple" id="countriesSelectScatter" name="countriesSelectScatter[]">
                                    <option th:each="country : ${countries}" th:value="${country.iso_code}" th:text="${country.display_name}"></option>
                                </select>
                            </div>
                            <div class="my-row mt-4">
                                <select class="form-control single-selection" id="single-xField">  
                                    <option value="">-- Select an field for X Axe --</option>
                                    <option th:each="fieldOption : ${fieldOptions}" th:value="${fieldOption.value}" th:text="${fieldOption.name}"></option>
                                </select>
                            </div>
                            <div class="my-row mt-4">
                                <!-- TODO -->
                                <select class="form-control single-selection" id="single-yField">  
                                    <option value="">-- Select an field for Y Axe --</option>
                                    <option th:each="fieldOption : ${fieldOptions}" th:value="${fieldOption.value}" th:text="${fieldOption.name}"></option>
                                </select>
                            </div>
                            <div id ="scatter-single-year-container">
                                <div class="mt-4 d-flex justify-content-center align-items-center">
                                    <label for="scatterSingleYear mr-2">Year:</label>
                                    <input class="year-input ml-3" type="number" name="single-year" id="scatterSingleYear">
                                </div>
                            </div>
                            <div id ="scatter-range-year-container" >
                                <h6 class="mt-4">Year Range Selector</h6>
                                <div class="my-row">
                                    <input class="year-input" type="number" name="min-year" id="scatter-min-year">
                                    <span>-</span>
                                    <input class="year-input" type="number" name="max-year" id="scatter-max-year">
                                </div>
                            </div>


                        </div>
                        <!-- Update chart btn -->
                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-primary ml-4 h-100" title="Execute" id="update-charts" onclick="updateChart()">
                                <i class="fa-solid fa-rotate"></i> Update Chart
                            </button>
                        </div>
                    </div>
                    <p  class="no-chart-paragraph">
                        Create a new chart by clicking on the <i class="fa-solid fa-circle-plus" onclick="addChart()"></i> button and then select it by clicking on its header.                                       
                    </p>
                </div>
            </div>
            <div class="tab">
              <input type="radio" name="css-tabs" id="tab-2" class="tab-switch">
              <label for="tab-2" class="tab-label">Settings</label>
              <div class="tab-content">
                <p  class="no-chart-paragraph">
                    Create a new chart by clicking on the <i class="fa-solid fa-circle-plus" onclick="addChart()"></i> button and then select it by clicking on its header.                    
                </p>
                <div id="chartSettings" class="data-source">
                    <h3>Chart Settings</h3>
                    <p>
                        These settings apply to the selected chart
                    </p>
                    <div class="settings-options">
                        <div class="option">
                            <label for="chartTitle">Chart Title</label>
                            <input type="text" id="chartTitle" name="chartTitle" value="" placeholder="Chart title">
                        </div>
                        
                        <div class="option">
                            <label for="yTitle">Y-Axis Title</label>
                            <input type="text" id="yTitle" name="yTitle" value="" placeholder="Y-Axis title">
                        </div>
                        <div class="option">
                            <label for="xTitle">X-Axis Title</label>
                            <input type="text" id="xTitle" name="xTitle" value="" placeholder="X-Axis title">
                        </div>
                        <div class="settings-btn">
                            <button type="button" class="btn btn-sm btn-primary ml-4" title="Execute" id="update-charts" onclick="updateChart()">
                                <i class="fa-solid fa-rotate"></i> Update Chart
                            </button>
                        </div>
                    </div>
    
                </div>
              </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-confirm modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header flex-column">
                    <h4 class="modal-title w-100">Delete chart</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="delete-chart-p">Do you really want to delete the selected chart?</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button onclick="deleteChart()" id = "delete-selected-chart" type="button" class="btn btn-danger" data-dismiss="modal">Delete</button>
                </div>
            </div>
        </div>
    </div>

    
</body>
</html>

<script th:inline="javascript">
/*<![CDATA[*/
const countries = /*[[${countries}]]*/ [];
console.log("countries:", countries);
function getCountryNameByIsoCode(isoCode) {
  for (let i = 0; i < countries.length; i++) {
    if (countries[i].iso_code === Number(isoCode)) {
      return countries[i].iso3;
    }
  }
  return null; // Return null if the iso_code is not found
}

function getRandomColors(numColors) {
  const colors = [];

  for (let i = 0; i < numColors; i++) {
    // Generate a random hex color code
    const colorCode = "#" + Math.floor(Math.random() * 16777215).toString(16);
    colors.push(colorCode);
  }
  return colors;
}

let sidebarOpen = false;
let chartsSequence = 0;
let chartsIds = [];
let charts = {};
let chartToDelete = null;
let selectedChart = null;

$(document).ready(function() {
    $("#scatter-single-year-container").hide();
    $("#fixedYear-countries").hide();
    window.addEventListener('resize', function(){
        for(const chartID of chartsIds){
            setTimeout(function() { // wait for the transition to finish
                Plotly.relayout(chartID, {
                    width: $('.chart-body').width(), // Set the chart's width to match the parent container width
                    height: $('.chart-body').height() // Set the chart's height to match the parent container height
                });
            }, 600); // set a timeout of 550 milliseconds
        }
    });


    $("#single-country").select2();

    $("#single-xField").select2();
    $("#single-yField").select2();
    

    $('#countriesSelect').multiSelect({
    selectableHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Search'>",
    selectionHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Search'>",
    afterInit: function(ms){
        var that = this,
            $selectableSearch = that.$selectableUl.prev(),
            $selectionSearch = that.$selectionUl.prev(),
            selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
            selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

        that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
        .on('keydown', function(e){
        if (e.which === 40){
            that.$selectableUl.focus();
            return false;
        }
        });

        that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
        .on('keydown', function(e){
        if (e.which == 40){
            that.$selectionUl.focus();
            return false;
        }
        });
    },
    afterSelect: function(){
        this.qs1.cache();
        this.qs2.cache();
    },
    afterDeselect: function(){
        this.qs1.cache();
        this.qs2.cache();
    }
    });
    $('#fieldsSelect').multiSelect({
    selectableHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Search'>",
    selectionHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Search'>",
    afterInit: function(ms){
        var that = this,
            $selectableSearch = that.$selectableUl.prev(),
            $selectionSearch = that.$selectionUl.prev(),
            selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
            selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

        that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
        .on('keydown', function(e){
        if (e.which === 40){
            that.$selectableUl.focus();
            return false;
        }
        });

        that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
        .on('keydown', function(e){
        if (e.which == 40){
            that.$selectionUl.focus();
            return false;
        }
        });
    },
    afterSelect: function(){
        this.qs1.cache();
        this.qs2.cache();
    },
    afterDeselect: function(){
        this.qs1.cache();
        this.qs2.cache();
    }
    });

    $("#countriesSelectScatter").multiSelect({
        selectableHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Search'>",
        selectionHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Search'>",
        afterInit: function(ms){
            var that = this,
                $selectableSearch = that.$selectableUl.prev(),
                $selectionSearch = that.$selectionUl.prev(),
                selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

            that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
            .on('keydown', function(e){
            if (e.which === 40){
                that.$selectableUl.focus();
                return false;
            }
            });

            that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
            .on('keydown', function(e){
            if (e.which == 40){
                that.$selectionUl.focus();
                return false;
            }
            });
        },
        afterSelect: function(){
            this.qs1.cache();
            this.qs2.cache();
        },
        afterDeselect: function(){
            this.qs1.cache();
            this.qs2.cache();
        }
    });
    
    $('#chartType').change(function() {
        let selectedOption = $(this).val();
        // Perform actions based on the selected option
        if (selectedOption === 'lines+markers' || selectedOption === 'bar') {
            // Timeline chart selected
            $("#scatter-selector").hide();
            $("#time-series-selector").show(); 
            console.log('Timeline chart selected');
        } else if (selectedOption === 'markers') {
            // Scatter plot selected
            // Add your logic here
            $("#scatter-selector").show();
            $("#time-series-selector").hide();
            console.log('Scatter plot selected');
        }
    });

    $('input[name="scatterRadio"]').change(function() {
        let selectedOption = $(this).attr('id');
        
        // Perform actions based on the selected option
        if (selectedOption === 'country') {
            // Country selected
            $("#fixedCountry-countries").show();
            $("#fixedYear-countries").hide();
            $("#scatter-single-year-container").hide();
            $("#scatter-range-year-container").show();
            
            console.log('Country selected');
        } else if (selectedOption === 'year') {
            // Year selected
            $("#fixedCountry-countries").hide();
            $("#fixedYear-countries").show();
            $("#scatter-single-year-container").show();
            $("#scatter-range-year-container").hide();
            console.log('Year selected');
        }
    });
});



class Chart {
    constructor(
        id,
        chartType = "lines+markers",
        showLegend = false,
        chartTitle = "",
        xTitle = "",
        yTitle = "",

    ) {
        this._id = id;
        this._chartType = chartType;
        this._showLegend = showLegend;
        this._chartTitle = chartTitle;
        this._xTitle = xTitle;
        this._yTitle = yTitle;
    }
    // Getters
    get id() {
        return this._id;
    }
    get chartType() {
        return this._chartType;
    }
    
    get showLegend() {
        return this._showLegend;
    }
    get xRange() {
        return this._xRange;
    }
    
    get chartTitle() {
        return this._chartTitle;
    }
    get xTitle() {
        return this._xTitle;
    }
    get yTitle() {
        return this._yTitle;
    }
    // Setters
    set id(newId) {
        this._id = newId;
    }
    set chartType(newChartType) {
        this._chartType = newChartType;
    }
    
    set showLegend(newShowLegend) {
        this._showLegend = newShowLegend;
    }
    set chartTitle(newChartTitle) {
        this._chartTitle = newChartTitle;
    }
    set xTitle(newXTitle) {
        this._xTitle = newXTitle;
    }
    set yTitle(newYTitle) {
        this._yTitle = newYTitle;
    }
    // Methods

    // Draw method to display the chart
    draw() {
        //set Title
        $('#'+this._id+'-title').text(this._chartTitle);
        console.log("countries: ", this._countries);
        console.log("fields: ", this._fields);
        console.log("chartType: ", this._chartType);
        // Call the appropriate getData function based on chart type
        let chartData;
        if (this._chartType === "lines+markers" || this._chartType === "bar") {
            chartData = this.getTimeSeriesData();
        }else if (this._chartType === "markers") {
            chartData = this.getScatterData();
        } else {
            // Handle unsupported chart types
            console.error("Unsupported chart type: " + this._chartType);
            return;
        }

        if(chartData == null ){
            //clear chart
            Plotly.react(this._id);
            return;
        }
        const tracesToDraw = [];

        for( let countryCode in chartData){
            console.log("countryCode: ", countryCode);
            for(let field in chartData[countryCode]){
                const trace = {
                    x: chartData[countryCode][field].x,
                    y: chartData[countryCode][field].y,
                    name: this._countries[countryCode] + " " + field,
                    mode: this._chartType,
                    type: this._chartType ==="markers"?"scatter":this._chartType,
                }
                tracesToDraw.push(trace);
            }
        }

        
        const layout = {
            margin: {
                l: 100,
                r: 100,
                b: 70,
                t: 50,
                pad: 4
            },
            xaxis: {
                title: this._xTitle,
            },
            yaxis: {
                title: this._yTitle,
                // exponentformat: "none",
                autorange: true,
            }, 
            showlegend: this._showLegend,
            legend: {
                x: 1.1,
                y: 0.5,
                traceorder: 'normal',
                font: {
                    family: 'sans-serif',
                    size: 12,
                    color: '#000'
                },
                bgcolor: '#E2E2E2',
                bordercolor: '#FFFFFF',
                borderwidth: 2
            } 
            
        };
        Plotly.react(this._id, tracesToDraw, layout);
        
        
    }

    toggleLegend(){
        Plotly.relayout(this._id, {
            showlegend: this._showLegend,

        });
    }
    getTimeSeriesData(){
        console.error("getTimeSeriesData not implemented");
        return null;        
    }
    
}

class TimeSeries extends Chart{
    constructor(id,chartType, showLegend, chartTitle, xTitle, yTitle, countries, fields, xRange, aggTime){
        super(id,chartType, showLegend, chartTitle, xTitle, yTitle);
        this._countries = countries;
        this._fields = fields;
        this._xRange = xRange;
        this._aggTime = aggTime;
    }
    get countries() {
        return this._countries;
    }
    get fields() {
        return this._fields;
    }
    get xRange() {
        return this._xRange;
    }
    get aggTime() {
        return this._aggTime;
    }
    // Setters
    set countries(newCountries) {
        this._countries = newCountries;
    }
    set fields(newFields) {
        this._fields = newFields;
    }
    set xRange(newXRange) {
        this._xRange = newXRange;
    }
    set aggTime(newAggTime) {
        this._aggTime = newAggTime;
    }
    // Methods
    getTimeSeriesData(){
        let myFields = {};
        for( let field of this._fields){
            let tableName = field.split("$")[0];
            let fieldName = field.split("$")[1];
            if( tableName === fieldName){
                myFields[tableName] = [];
            }
            else{
                if( tableName in myFields){
                    myFields[tableName].push(fieldName);
                }else{
                    myFields[tableName] = [fieldName];
                }
            }
        }
        console.log("myFields: ", myFields);
        //TODO: Dwse k to aggTime an to chartsType einai bar
        let data= {
            "countries": Object.keys(this._countries),
            "fields": myFields,
            "years": this._xRange,
        };
        console.log("data: ",data);
        let chartData = {}
        $.ajax({
            url: "/api/getTimeseriesData",
            type: "POST",
            contentType: "application/json",
            async: false,
            data: JSON.stringify(data),
        }).done(function(response){
            chartData = response.data;
            console.log("Timeseries data: ",chartData);
        }).fail(function(err){
            console.log("err: ",err);
            chartData = null;
        });
        return chartData;
    }
}

class Scatter extends Chart{
    constructor(id,chartType, showLegend, chartTitle, xTitle, yTitle, fixedField, countries, xField, yField, years){
        super(id,chartType, showLegend, chartTitle, xTitle, yTitle);
        this._fixedField = fixedField;
        this._countries = countries;
        this._xField = xField;
        this._yField = yField;
        this._years = years;
    }
    //Getters
    get fixedField() {
        return this._fixedField;
    }
    get countries() {
        return this._countries;
    }
    get xField() {
        return this._xField;
    }
    get yField() {
        return this._yField;
    }
    get years() {
        return this._years;
    }
    // Setters
    set fixedField(newFixedField) {
        this._fixedField = newFixedField;
    }
    set countries(newCountries) {
        this._countries = newCountries;
    }
    set xField(newXField) {
        this._xField = newXField;
    }
    set yField(newYField) {
        this._yField = newYField;
    }
    set years(newYears) {
        this._years = newYears;
    }
    // Methods

    getScatterData(){
        let myXField = {};
        let xTableName = this._xField.split("$")[0];
        let xFieldName = this._xField.split("$")[1];
        if ( xTableName === xFieldName){
            myXField[xTableName] = "";
        }else{
            myXField[xTableName] = xFieldName;
        }

        let myYField = {};
        let yTableName = this._yField.split("$")[0];
        let yFieldName = this._yField.split("$")[1];
        if ( yTableName === yFieldName){
            myYField[yTableName] = "";
        }else{
            myYField[yTableName] = yFieldName;
        }


        let data= {
            "fixedField": this._fixedField,
            "countries": Object.keys(this._countries),
            "xField": myXField,
            "yField": myYField,
            "years": this._years,
        };
        console.log("SCATTER data: ",data);
        let chartData = {}
        $.ajax({
            url: "/api/getScatterData",
            type: "POST",
            contentType: "application/json",
            async: false,
            data: JSON.stringify(data),
        }).done(function(response){
            console.log("RESPONSE Scatter data: ",response);
            chartData = response.dataPoints;
        }).fail(function(err){
            console.log("err: ",err);
            chartData = null;
        });
        return chartData;
    }
    draw() {
        //set Title
        let myTitle = this._chartTitle
        if( myTitle === ""){
            if(this._fixedField === "country"){
                myTitle = Object.values(this._countries)[0];
            }
            else if (this._fixedField === "year"){
                myTitle = this._years.min;
            }
        }
        $('#'+this._id+'-title').text(myTitle);
        console.log("countries: ", this._countries);
        console.log("fields: ", this._fields);
        console.log("chartType: ", this._chartType);
        // Call the appropriate getData function based on chart type
        let chartData = this.getScatterData();

        if(chartData == null ){
            //clear chart
            Plotly.react(this._id);
            return;
        }
        const tracesToDraw = [];
        let myX = []
        let myY = []
        let rm = []
        for( let point of chartData){
            myX.push(point.x);
            myY.push(point.y);
            if (this._fixedField === "country"){
                rm.push(point.year);
            }
            else if (this._fixedField === "year"){
                rm.push(getCountryNameByIsoCode(point.country));
            }
            
        }
        console.log("tracesToDraw: ", tracesToDraw);
        const trace = {
                x: myX,
                y: myY,
                text: rm,
                textposition: 'top center',
                textfont: {
                    family:  'Raleway, sans-serif'
                },
                name: this._fixedField ==='country'?Object.values(this._countries)[0]: this._years.min,
                mode: 'markers+text',
                marker:{
                    //random color for all markers
                    color : getRandomColors(chartData.length), 
                },
                type: "scatter",
            }
        tracesToDraw.push(trace);
        
        const layout = {
            margin: {
                l: 100,
                r: 100,
                b: 70,
                t: 50,
                pad: 4
            },
            xaxis: {
                title: this._xTitle === ""? this._xField.split("$")[1] : this._xTitle,
            },
            yaxis: {
                title: this._yTitle === ""? this._yField.split("$")[1] : this._yTitle,
                // exponentformat: "none",
                autorange: true,
            }, 
            showlegend: this._showLegend,
            legend: {
                x: 1.1,
                y: 0.5,
                traceorder: 'normal',
                font: {
                    family: 'sans-serif',
                    size: 12,
                    color: '#000'
                },
                bgcolor: '#E2E2E2',
                bordercolor: '#FFFFFF',
                borderwidth: 2
            } 
            
        };
        Plotly.react(this._id, tracesToDraw, layout);
        
        
    }

}

function addChart(){
    console.log("add chart");
    // $("#scatter-selector").hide();
    let ID = chartsSequence;
    chartsIds.push("chart"+ID);
    charts["chart"+ID] = new TimeSeries("chart"+ID,"lines+markers",false,"","","",{},[],{},"none");
    chartsSequence++;
    $('.charts-container').append(`
        <div id="chart_container_${ID}" class="chart-container ${sidebarOpen? "chart-container-move-left":""}">
            <div class="chart-header" onclick = selectChart("${ID}")>
                <div class='move-chart ml-2'>
                    <i class="fas fa-arrow-up" onclick = moveChart("up","chart_container_${ID}")></i>
                    <i class="fas fa-arrow-down" onclick = moveChart("down","chart_container_${ID}")></i>
                </div>
                <div class="chart-title d-flex align-items-center justify-content-center">
                    <h5 class="m-0" id="chart${ID}-title"></h5>
                </div>
                <div class='d-flex align-items-center justify-content-center'>
                    <span class="toggle-legend-btn mb-1 mr-2" title="Show legend" onclick = toggleLegend("${ID}") >≡</span>
                    <i  onclick=setChartToDelete(event,"chart_container_${ID}") data-toggle="modal" data-target="#deleteModal" class="fas fa-trash  delete-chart-btn"></i>
                </div>
            </div>
            <div class="chart-body">
                <div id="chart${ID}" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    `);
    Plotly.newPlot('chart'+ID);
    

}
function toggleSidebar(){
    sidebarOpen = !sidebarOpen;
    window.dispatchEvent(new Event('resize'))
    $("#sidebar").toggleClass("move-to-left");
    $("#sidebar-tab").toggleClass("move-to-left");
    $("main").toggleClass("move-to-left-partly");
    $(".arrow").toggleClass("active");
    $(".chart-container").toggleClass("chart-container-move-left")
    $(".add-btn-icon").toggleClass("move-to-left-btn");
    $(".range-selector").toggleClass("chart-container-move-left");
    // Trigger a resize event to update the chart's layout properties
    window.dispatchEvent(new Event('resize'));
    
}
function updateChart(){
    let chartType = $("#chartType").val();
    let chartTitle = $("#chartTitle").val();
    let xTitle = $("#xTitle").val();
    let yTitle = $("#yTitle").val();
    if( chartType === "lines+markers" || chartType === "bar"){
        let counties = $("#countriesSelect").val().reduce(function(result, value, index, arr){
            result[value] = $("#countriesSelect option[value='"+value+"']").text();
            return result;
        }, {});
        let fields = $("#fieldsSelect").val();
        let xRange = { min: $("#min-year").val(), max: $("#max-year").val() };
        let aggTime = "none";
        if ( chartType === "bar"){
            aggTime = $('input[name="customRadioInline1"]:checked').attr('id');
        }
        
        delete charts[selectedChart];

        charts[selectedChart] = new TimeSeries(selectedChart,chartType,false, chartTitle, xTitle, yTitle, counties, fields, xRange, aggTime);
        charts[selectedChart].draw();
    }else if ( chartType === "markers"){
        let fixedField = $('input[name="scatterRadio"]:checked').attr('id');
        console.log("fixedField: ",fixedField);
        let xField = $("#single-xField").val();
        let yField = $("#single-yField").val();
        if(fixedField === "country"){
            let country = {};
            country[$("#single-country").val()] = $("#single-country option[value='"+$("#single-country").val()+"']").text();
            console.log("fixedcountry country:", country);
            let years = { min: $("#scatter-min-year").val(), max: $("#scatter-max-year").val() };
            delete charts[selectedChart];
            charts[selectedChart] = new Scatter(selectedChart,chartType,false, chartTitle, xTitle, yTitle,fixedField, country, xField, yField, years);
            charts[selectedChart].draw();
        }else if ( fixedField === 'year'){
            let countries = $("#countriesSelectScatter").val().reduce(function(result, value, index, arr){
                result[value] = $("#countriesSelectScatter option[value='"+value+"']").text();
                return result;
            }, {});
            
            console.log("fixedyear countries:", countries);
            let years = { min: $("#scatterSingleYear").val(), max: $("#scatterSingleYear").val() };
            delete charts[selectedChart];
            charts[selectedChart] = new Scatter(selectedChart,chartType,false, chartTitle, xTitle, yTitle,fixedField, countries, xField, yField, years);
            charts[selectedChart].draw();
        }

    }
    console.log("chart updated!");
}
function deleteChart(){
    modified = true;
    $("#"+chartToDelete).remove();
    //remove from chartsIds
    chartsIds = chartsIds.filter(function(value, index, arr){
        return value != 'chart'+chartToDelete.split("_")[2];
    });
    //remove from charts
    delete charts['chart'+chartToDelete.split("_")[2]];
    if(chartsIds.length == 0){
        $(".no-chart-paragraph").show();
        $(".data-source").css("display", "none");
    }

}
function setChartToDelete(event,chartId){
    chartToDelete = chartId;
}

function clearSelector(){
    $("#fixedYear-countries").show();
        $("#scatter-single-year-container").show();
        $("#fixedCountry-countries").show();
        $("#scatter-range-year-container").show();
        $("#country").prop("checked", true);
        $("#single-country").val("").trigger('change');
        $("#countriesSelectScatter").multiSelect('deselect_all');
        $("#single-xField").val("").trigger('change');
        $("#single-yField").val("").trigger('change');
        $("#scatter-min-year").val("");
        $("#scatter-max-year").val("");
        $("#scatterSingleYear").val("");
        $("#fixedYear-countries").hide();
        $("#scatter-single-year-container").hide();

        $("#countriesSelect").multiSelect('deselect_all');
        $("#fieldsSelect").multiSelect('deselect_all');
        $("#min-year").val("");
        $("#max-year").val("");
}

function selectChart(chartId){
    if ( event.target.closest(".delete-chart-btn") ) return;
    selectedChart = "chart"+chartId;


    //make the chart_container_+chartId child div with class= chart-header background color = #f5f5f5
    // $("#chart_container_"+chartId+" .chart-header").css("background-color", "green");
    $("#chart_container_"+chartId).css("border", "3px solid #90EE90");
    //and all other divs that starts with chart_container_ child div with class= chart-header background color = #fff
    // $(".chart-header").not("#chart_container_"+chartId+" .chart-header").css("background-color", "#444b53");
    $(".chart-container").not("#chart_container_"+chartId).css("border", "2px solid #444b53");
    if(!sidebarOpen){
        toggleSidebar();        
    }
    $(".no-chart-paragraph").hide();
    $(".data-source").css("display", "flex");
    
    //fetch chart settings
    $("#chartTitle").val(charts[selectedChart].chartTitle);
    $("#xTitle").val(charts[selectedChart].xTitle);
    $("#yTitle").val(charts[selectedChart].yTitle);
    let chartType = charts[selectedChart].chartType;
    $("#chartType").val(chartType);
    if(chartType === "lines+markers" || chartType === "bar"){
        //clear selector
        clearSelector();
        //----------
        $("#scatter-selector").hide();
        $("#time-series-selector").show();
        
        $("#countriesSelect").multiSelect('select', Object.keys(charts[selectedChart].countries));
        
        $("#fieldsSelect").multiSelect('select', charts[selectedChart].fields);
        
        $("#min-year").val(charts[selectedChart].xRange.min);
        
        $("#max-year").val(charts[selectedChart].xRange.max);
        $("#"+charts[selectedChart].aggTime).prop("checked", true);
    }else if( chartType === 'markers'){
        console.log("selectedChart:", selectedChart, charts[selectedChart])
        $("#scatter-selector").show();
        $("#time-series-selector").hide();
        //clearselector
        clearSelector();
        $("#fixedYear-countries").hide();
        $("#scatter-single-year-container").hide();

        //----------
        let fixedField = charts[selectedChart].fixedField;
        $("#"+fixedField).prop("checked", true);
        $("#fixedCountry-countries").hide();
        $("#scatter-range-year-container").hide();

        $("#single-xField").val(charts[selectedChart].xField).trigger('change');
        $("#single-yField").val(charts[selectedChart].yField).trigger('change');
        
        if (fixedField === 'country'){
            $("#fixedCountry-countries").show();
            $("#scatter-range-year-container").show();
            $("#single-country").val(Object.keys(charts[selectedChart].countries)[0]).trigger('change');
            
            $("#scatter-min-year").val(charts[selectedChart].years.min);
            $("#scatter-max-year").val(charts[selectedChart].years.max);
        }else if ( fixedField === 'year'){
            $("#fixedYear-countries").show();
            $("#scatter-single-year-container").show();
            $("#countriesSelectScatter").multiSelect('deselect_all');
            $("#countriesSelectScatter").multiSelect('select', Object.keys(charts[selectedChart].countries));
            $("#scatterSingleYear").val(charts[selectedChart].years.min);

        }


    }
    
}
function moveChart(move, chartContainerID){
    event.stopPropagation();
    if (move == "up"){
        $("#"+chartContainerID).insertBefore($("#"+chartContainerID).prev());
    }else if(move == "down"){
        $("#"+chartContainerID).insertAfter($("#"+chartContainerID).next());
    }
}

function toggleLegend(Id){
    event.stopPropagation();
    let chartId = "chart"+Id;
    let chartsContainer = "chart_container_"+Id;
    if(!charts[chartId].showLegend){
        $("#"+chartsContainer+" .toggle-legend-btn").css("color", "#fff");
        $("#"+chartsContainer+" .toggle-legend-btn").attr("title", "Hide Legend");
        charts[chartId].showLegend = true;
        charts[chartId].toggleLegend();
    }else{
        $("#"+chartsContainer+" .toggle-legend-btn").css("color", "#6c757d");
        $("#"+chartsContainer+" .toggle-legend-btn").attr("title", "Show Legend");
        charts[chartId].showLegend = false;
        charts[chartId].toggleLegend();
    }
}



 /*]]>*/
</script>

